---
layout: post
title: HTTPS 协议剖析
description: 为什么会产生 HTTPS 协议？HTTPS 协议设计的原理
published: true
category: http
---

## 背景

有几个疑问：

1. 为什么会产生 HTTPS？解决什么问题？
2. HTTPS 跟 HTTP 什么关系？S 是什么含义？
3. HTTPS 连接建立的过程？中间涉及几个主体？

## HTTPS 解决什么问题

HTTP 协议传输的内容，因为是明文的，存在几个问题：（**安全问题**）

1. 偷窥（嗅探）：传输内容被偷窥
2. 篡改：传输内容被篡改
3. 重放攻击：抓到网络上 HTTP 请求后，重放多次，导致服务异常

为了解决上述问题，HTTPS 诞生，其本质是 HTTP over SSL/TLS，相当于基于 HTTPS 做了一层'加密/解密'。


### 最原始解决方法

但是，简单的加密、解密无法解决上述问题：（简单的加密：把密钥存放到 HTTP 的头部）

1. Web 服务：Client 是浏览器，而且默认是任何浏览器都可以访问的，因此，需要公开全网的解密算法
2. 密钥放到 HTTP 头部：任何人都可以获取到
3. 由于有`公开的解密算法`和`公开的解密密钥`，因此，仍可以偷窥、篡改网页内容

从上面，可以看出：

* **浏览器（Client）默认被信任的**，这是 Web 服务的典型特点;
* 因此，**不能在 HTTP 响应中，包含解密密钥**。

todo：添加图片

结论：

> 传统的加密、解密，无法解决 HTTP 的安全问题。

### HTTPS 协议的设计需求

整体几个方面，HTTPS 要满足下面几点：

1. 兼容性：现有 HTTP，后有 HTTPS，因此，设计 HTTPS 时，需要考虑兼容 HTTP，具体：
	1. Web 应用无缝迁移：无缝迁移到 HTTPS
	2. 浏览器厂商：支持 HTTPS 的改动尽可能小
2. 


补充：

基于`兼容性`考虑，得出结论：

1. HTTPS 还是要基于 TCP 来传输：调整为基于 




## HTTPS 连接建立过程

几个核心问题：

1. HTTPS 连接建立过程
2. HTTPS 数据传输过程
3. HTTPS 解决的问题？（相对 HTTP）



## 术语解释

### HTTP

HTTP，超文本传输协议，应用层的协议，大部分网站都是通过 HTTP 协议来传输 Web 页面、以及 Web 页面上包含的各种东东（图片、CSS 样式、JS 脚本）。

### SSL/TSL

很多相关的文章都把这两者并列称呼（SSL/TLS），两者可以视作同一个东西的不同阶段：

* `SSL`，`Secure Sockets Layer`，**安全套接层**；它是在上世纪90年代中期，由网景公司设计的。（顺便插一句，网景公司不光发明了 SSL，还发明了很多 Web 的基础设施——比如“CSS 样式表”和“JS 脚本”）
* `TLS`，`Transport Layer Security`，**传输层安全协议**；到了1999年，`SSL` 因为应用广泛，已经成为互联网上的事实标准。IETF 就在那年把 `SSL` 标准化。标准化之后的名称改为 `TLS`


为啥要发明 SSL 这个协议捏？

1. 原先互联网上使用的 HTTP 协议是明文的
2. HTTP 协议，存在很多缺点，
	3. 偷窥（嗅探）：传输内容
	4. 篡改：传输内容

`SSL` 协议，就是为了解决这些问题。

### HTTPS

HTTPS，`HTTP over SSL`，或者 `HTTP over TLS`：

* 通常所说的 HTTPS 协议，说白了就是“**HTTP 协议**”和“**SSL/TLS 协议**”的组合。
* 可以把 HTTPS 大致理解为“HTTP over SSL”或“HTTP over TLS”（反正 SSL 和 TLS 差不多）。

## HTTP 协议的特点

### HTTP 的版本和历史

出现过 3 种 HTTP 协议版本：

1. HTTP 0.9：
	2. 未广泛使用
2. HTTP 1.0：
	3. 广泛使用
	4. 短链接
3. HTTP 1.1：
	1. 广泛使用
	2. 长连接

### HTTP 与 TCP 之间关系

HTTP 是应用层协议，其传输层使用 TCP 协议。

TCP 协议：

1. 面向连接
2. 可靠
3. 数据顺序到达

### HTTP 如何使用 TCP？

使用 TCP 的 2 种方式：

* 短连接：每次都创建一个 TCP 连接，使用完之后就释放；
* 长连接：Keep-Alive，持久连接，一个 TCP 连接建立后，会多次复用，不会使用一次就释放掉；

举例：

短连接：

1. 通过 HTTP 请求，获取网页，会建立一个 TCP 连接，请求到网页内容后，**TCP 连接释放**；
2. 再次请求网页内的 图片和外部 CSS、JS 时，会**重新创建 TCP 连接**；

长连接：

1. 通过 HTTP 请求，获取网页，会建立一个 TCP 连接，请求到网页内容后，**TCP 连接仍然保持**；
2. 再次请求网页内的 图片和外部 CSS、JS 时，会**复用之前 TCP 连接**；

HTTP 如何使用 TCP ？

* HTTP 1.0 使用 TCP 短连接：因为当时网页比较简单（互联网初期）；
* HTTP 1.1 使用 TCP 长连接：通过 keep-alive 字段控制，有一个超时时间，以更好适应网页中包含大量图片以及外部 CSS 和 JS 的情况；

思考：

1. TCP 长连接中，keep-alive 是谁设置的？
2. keep-alive，超时之后，谁负责释放 TCP 连接？
3. 超时时间，同时保存在 client 和 server 侧？

## 加密：对称加密和非对称加密

加密：

* 涉及概念：明文、密文、密钥
* 加密：使用**密钥**，对**明文**加密，获得**密文**


整体过程：

todo: 加密-解密过程，图片


加密密钥、解密密钥：

* 对称加密：**加密密钥**跟**解密密钥**完全相同
* 非对称加密：**加密密钥**跟**解密密钥**不相同

从功能角度而言：

* “**非对称加密**”优点：能做的事情更多，（思考：比如，哪些事情对称加密做不了？）
* “**非对称加密**”缺点：，涉及“复杂数学问题”，性能相对更差一点；

这两者的优缺点，也影响到了 SSL 协议的设计。（思考：比如，哪些影响？）

## CA 证书的用途和原理

todo














## 参考资料

* [扫盲 HTTPS 和 SSL/TLS 协议[1]：背景知识、协议的需求、设计的难点](https://program-think.blogspot.com/2014/11/https-ssl-tls-1.html)




[NingG]:    http://ningg.github.com  "NingG"